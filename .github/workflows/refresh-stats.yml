# Refresh European Parliament Statistics
#
# Fetches live counts from the EP Open Data Portal API, updates the static
# data in src/data/generatedStats.ts, validates both raw data AND computed
# stats (derived intelligence, rankings, predictions, monthly distributions),
# and commits the result when all checks pass.
#
# The EP API does not provide a totalItems header, so all records are iterated
# to obtain accurate counts (limit: 1000 per page, the API's server-side cap).
#
# Runs weekly (all years) or on demand (specific year).
#
# ISMS Policy: AU-002 (Audit Logging), SC-002 (Input Validation)
# Data source: European Parliament Open Data Portal â€” data.europarl.europa.eu

name: Refresh EP Stats

on:
  schedule:
    # Every Monday at 06:00 UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      year:
        description: 'Year to validate (leave empty for latest covered year, "all" for all years)'
        required: false
        default: ''
        type: string

permissions:
  contents: write

jobs:
  refresh-stats:
    name: Update & Validate EP Statistics
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch API data and update stats
        run: |
          INPUT_YEAR="${STATS_YEAR}"
          # Default: scheduled runs update all years; manual can pick one
          if [ -z "${INPUT_YEAR}" ]; then
            ARGS="--all --update"
          elif [ "${INPUT_YEAR}" = "all" ]; then
            ARGS="--all --update"
          elif [[ "${INPUT_YEAR}" =~ ^[0-9]{4}$ ]]; then
            ARGS="--year ${INPUT_YEAR} --update"
          else
            echo "Error: Invalid year input '${INPUT_YEAR}'. Must be 'all' or a 4-digit year (e.g. 2024)." >&2
            exit 1
          fi
          echo "Running: npx tsx scripts/generate-stats.ts $ARGS"
          npx tsx scripts/generate-stats.ts $ARGS
        env:
          NODE_ENV: production
          STATS_YEAR: ${{ github.event.inputs.year }}

      - name: Validate data integrity and computed stats
        run: npx vitest run src/data/generatedStats.test.ts --reporter=verbose

      - name: Type-check updated stats
        run: npx tsc --noEmit

      - name: Commit updated stats
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add src/data/generatedStats.ts
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: refresh EP stats from live API data [skip ci]"
            git push
            echo "Updated stats committed and pushed."
          fi
