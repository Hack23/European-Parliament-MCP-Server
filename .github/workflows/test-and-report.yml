name: Test and Report

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# Set default permissions to read-only
permissions: read-all

jobs:
  prepare:
    runs-on: ubuntu-latest
    # Only needs read permissions
    permissions:
      contents: read # Required to check out code
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "22"
          cache: "npm"

      - name: Cache dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

  build-validation:
    needs: prepare
    runs-on: ubuntu-latest
    # Needs write permissions to upload artifacts
    permissions:
      contents: write # Required to check out code
      actions: read # Required to use GitHub actions
      id-token: write # Required for attestation
      pull-requests: write # Required to upload artifacts (implicit permission)
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "22"
          cache: "npm"

      - name: Cache dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Cache build artifacts
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: dist
          key: ${{ runner.os }}-build-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('src/**/*') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-build-

      # TypeScript type checking
      - name: Type check
        run: npm run type-check

      # Run linter
      - name: Lint
        run: npm run lint

      # Check for unused dependencies with knip
      - name: Check for unused dependencies
        run: npm run knip

      # Check licenses
      - name: Check licenses
        run: npm run test:licenses

      - name: Generate SBOM
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
        id: sbom
        with:
          format: spdx-json
          output-file: european-parliament-mcp-server.spdx.json
          artifact-name: european-parliament-mcp-server

      - name: Install SBOMQS
        run: |
          curl -LO https://github.com/interlynk-io/sbomqs/releases/download/v1.2.0/sbomqs-linux-amd64
          sudo mv sbomqs-linux-amd64 /usr/local/bin/sbomqs
          sudo chmod a+x /usr/local/bin/sbomqs

      - name: Details SBOM Quality
        run: sbomqs score european-parliament-mcp-server.spdx.json --detailed

      - name: Check SBOM Quality
        run: |
          score=$(sbomqs score european-parliament-mcp-server.spdx.json --json | jq '.files[0].avg_score')
          echo "SBOM Score: $score/10"
          
          if (( $(echo "$score < 7.0" | bc -l) )); then
            echo "::error::SBOM quality score too low: $score"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-output
          path: |
            dist
            european-parliament-mcp-server.spdx.json
          if-no-files-found: warn

  unit-tests:
    needs: [prepare, build-validation]
    runs-on: ubuntu-latest
    # Needs write permissions to upload artifacts
    permissions:
      contents: write # Required to check out code
      actions: read # Required to use GitHub actions
      checks: write # Required to upload artifacts (implicit permission)
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "22"
          cache: "npm"

      - name: Cache dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Check coverage thresholds
        run: |
          # Extract coverage from report
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            echo "Current coverage: $COVERAGE%"
            
            # Convert coverage to integer (percentage * 100) for comparison
            COVERAGE_INT=$(awk -v c="$COVERAGE" 'BEGIN { printf "%d", c * 100 }')
            
            # Check if coverage meets requirements (80% minimum = 8000)
            if [ "$COVERAGE_INT" -lt 8000 ]; then
              echo "⚠️ Coverage $COVERAGE% is below required 80%"
              echo "::warning::Coverage $COVERAGE% is below required 80%"
            else
              echo "✅ Coverage $COVERAGE% meets requirement"
            fi
          else
            echo "⚠️ Coverage summary not found"
          fi
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.3.2
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: coverage-report
          path: coverage
          if-no-files-found: warn

  integration-tests:
    needs: [prepare, build-validation]
    runs-on: ubuntu-latest
    # Needs write permissions to upload artifacts
    permissions:
      contents: write # Required to check out code
      actions: read # Required to use GitHub actions
      checks: write # Required to upload artifacts (implicit permission)
      pull-requests: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "22"
          cache: "npm"

      - name: Cache dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      # TODO: Implement integration tests
      - name: Run integration tests
        run: |
          if npm run test:integration 2>/dev/null; then
            echo "Integration tests passed"
          else
            echo "⚠️ No integration tests configured yet - this is a template workflow"
            echo "To implement:"
            echo "1. Create integration test files: src/**/*.integration.test.ts"
            echo "2. Add test:integration script to package.json"
            echo "3. Test MCP server protocol implementation"
            echo "4. Test European Parliament API integration"
            exit 0
          fi
        continue-on-error: true

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: integration-test-results
          path: |
            test-results
            coverage
          if-no-files-found: warn

  report:
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    # Needs write permissions to upload artifacts
    permissions:
      contents: write # Required to check out code
      actions: read # Required to use GitHub actions
      checks: write # Required to upload artifacts (implicit permission)
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: artifacts
        continue-on-error: true

      - name: Upload combined reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-reports
          path: |
            artifacts/coverage-report
            artifacts/integration-test-results
          if-no-files-found: warn

      - name: Test summary
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Note**: This is a template workflow for future test implementation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Current Status" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build validation: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ⏳ Unit tests: Template (not implemented)" >> $GITHUB_STEP_SUMMARY
          echo "- ⏳ Integration tests: Template (not implemented)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Implementation Guide" >> $GITHUB_STEP_SUMMARY
          echo "1. Install testing framework (Vitest recommended)" >> $GITHUB_STEP_SUMMARY
          echo "2. Create unit tests for MCP server tools" >> $GITHUB_STEP_SUMMARY
          echo "3. Create integration tests for European Parliament API" >> $GITHUB_STEP_SUMMARY
          echo "4. Configure coverage reporting" >> $GITHUB_STEP_SUMMARY
