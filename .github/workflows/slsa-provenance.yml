name: SLSA Provenance and Attestations

on:
  push:
    tags: ["v*"]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  attestations: write
  actions: read

jobs:
  build:
    name: Build and Attest
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

      - name: Package for distribution
        run: |
          # Create tarball of dist directory
          tar -czf european-parliament-mcp-server.tar.gz -C dist .
          
          # Create npm package
          npm pack
          
          # Create source tarball
          git archive --format=tar.gz --prefix=european-parliament-mcp-server/ HEAD > source.tar.gz

      - name: Generate artifact hashes
        id: hash
        run: |
          # Generate SHA256 hashes for all artifacts
          sha256sum european-parliament-mcp-server.tar.gz > checksums.txt
          sha256sum european-parliament-mcp-server-*.tgz >> checksums.txt
          sha256sum source.tar.gz >> checksums.txt
          
          # Export hashes for provenance
          echo "hashes=$(sha256sum european-parliament-mcp-server.tar.gz european-parliament-mcp-server-*.tgz source.tar.gz | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Attest build artifacts
        uses: actions/attest-build-provenance@e4d4f7c39adfa4c260fb5c147f0622000aa14b99 # v2.0.1
        with:
          subject-path: |
            european-parliament-mcp-server.tar.gz
            european-parliament-mcp-server-*.tgz
            source.tar.gz

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.2
        with:
          name: build-artifacts
          path: |
            european-parliament-mcp-server.tar.gz
            european-parliament-mcp-server-*.tgz
            source.tar.gz
            checksums.txt

      - name: Attach artifacts to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.2.1
        with:
          files: |
            european-parliament-mcp-server.tar.gz
            european-parliament-mcp-server-*.tgz
            source.tar.gz
            checksums.txt

  provenance:
    name: Generate SLSA Provenance
    needs: [build]
    permissions:
      actions: read
      id-token: write
      contents: write
      attestations: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      # Only upload to release when triggered by release event
      upload-assets: ${{ github.event_name == 'release' }}
      # Only set tag name for release events; empty string for other triggers
      upload-tag-name: ${{ github.event_name == 'release' && github.ref_name || '' }}
      provenance-name: "provenance.intoto.jsonl"

  verify:
    name: Verify Attestations
    needs: [build, provenance]
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Download artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-artifacts

      - name: Verify build attestations
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Verify each artifact
          for artifact in european-parliament-mcp-server.tar.gz european-parliament-mcp-server-*.tgz source.tar.gz; do
            echo "üîç Verifying attestation for: $artifact"
            gh attestation verify "$artifact" \
              --owner Hack23 \
              --repo European-Parliament-MCP-Server || {
              echo "‚ùå Attestation verification failed for $artifact"
              exit 1
            }
            echo "‚úÖ Attestation verified for $artifact"
          done

      - name: Verify checksums
        run: |
          echo "üîç Verifying checksums..."
          sha256sum -c checksums.txt || {
            echo "‚ùå Checksum verification failed"
            exit 1
          }
          echo "‚úÖ All checksums verified"

  publish-npm:
    name: Publish to npm
    needs: [build, provenance, verify]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Download artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-artifacts

      - name: Publish to npm with provenance
        run: |
          npm publish european-parliament-mcp-server-*.tgz --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
